{% for post in posts %}
<div class="card mb-3 shadow-sm post-item">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <a href="{{ url_for('user_profile', username=post['author']) }}" class="text-decoration-none">
        {{ post['author'] }}
        {% if post.get('author_badges', {}).get('verified') %}
          <span class="badge bg-primary">✓</span>
        {% endif %}
      </a>
      <small class="text-muted"> • {{ time_ago(post['created_at']) }}</small>
    </div>
    {% if 'user_id' in session and post['author'] == session['username'] %}
    <div class="btn-group">
      <a href="{{ url_for('edit_post', post_id=post['_id']) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
      <form action="{{ url_for('delete_post', post_id=post['_id']) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
    </div>
    {% endif %}
  </div>
  <div class="card-body">
    <p class="post-content">{{ post['content'] }}</p>
    
    <!-- Hashtags -->
    {% if post.get('hashtags') %}
    <div class="mt-2">
      {% for tag in post['hashtags'] %}
      <a href="{{ url_for('view_hashtag', hashtag=tag) }}" class="badge bg-info text-decoration-none">#{{ tag }}</a>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Reactions -->
    <div class="mt-3">
      {% for emoji in ['❤️','🔥','😂','👍','🌱'] %}
      <form action="{{ url_for('react', post_id=post['_id'], emoji=emoji) }}" method="post" class="d-inline">
        <button type="submit" class="btn btn-sm btn-outline-secondary me-1">
          {{ emoji }} {{ post['reactions'].get(emoji, 0) }}
        </button>
      </form>
      {% endfor %}
    </div>
    
    <!-- Comments -->
    <div class="mt-3">
      {% for comment in post['comments'][-3:] %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <strong>{{ comment['username'] }}</strong>: <span class="comment-text">{{ comment['text'] }}</span>
          {% if comment.get('edited') %}<small class="text-muted"> (edited)</small>{% endif %}
        </div>
        {% if 'user_id' in session and (comment['username'] == session['username'] or post['author'] == session['username']) %}
        <div class="btn-group">
          {% if comment['username'] == session['username'] %}
          <a href="{{ url_for('edit_comment', post_id=post['_id'], comment_index=loop.index0) }}" class="btn btn-sm btn-link text-decoration-none">Edit</a>
          {% endif %}
          <form action="{{ url_for('delete_comment', post_id=post['_id'], comment_index=loop.index0) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
            <button type="submit" class="btn btn-sm btn-link text-decoration-none text-danger">Delete</button>
          </form>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if 'user_id' in session %}
      <form action="{{ url_for('comment', post_id=post['_id']) }}" method="post" class="mt-2">
        <div class="input-group">
          <input type="text" name="comment" class="form-control" placeholder="Add a comment..." required>
          <button type="submit" class="btn btn-outline-primary">Post</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}
