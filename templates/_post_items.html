{% for post in posts %}
<div class="card mb-3 shadow-sm post-item" id="post-{{ post['_id'] }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <a href="{{ url_for('user_profile', username=post['author']) }}" class="text-decoration-none">
        {{ post['author'] }}
        {% if post.get('author_badges', {}).get('verified') %}
          <span class="badge bg-primary">‚úì</span>
        {% endif %}
      </a>
      <small class="text-muted"> ‚Ä¢ {{ post['created_at']|time_ago if post['created_at'] else '' }}</small>
    </div>
    {% if 'user_id' in session and post['author'] == session['username'] %}
    <div class="btn-group">
      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editPostModal" data-post-id="{{ post['_id'] }}" data-content="{{ post['content'] }}" data-image-url="{{ post.get('image_url', '') }}">Edit</button>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ post['_id'] }}')">Delete</button>
    </div>
    {% endif %}
  </div>
  <div class="card-body">
    <p class="post-content">{{ post['content'] }}</p>
    
    <!-- Post Image -->
    {% if post.get('image_url') %}
    <div class="mt-2 mb-3">
      <img src="{{ post.image_url }}" alt="Post image" class="img-fluid rounded" style="max-height: 400px; width: auto; max-width: 100%;" data-action="view-image">
    </div>
    {% endif %}
    
    <!-- Hashtags -->
    {% if post.get('hashtags') %}
    <div class="mt-2">
      {% for tag in post['hashtags'] %}
      <a href="{{ url_for('view_hashtag', hashtag=tag) }}" class="badge bg-info text-decoration-none">#{{ tag }}</a>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Reactions -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <div>
        {% for emoji in ['‚ù§Ô∏è','üî•','üòÇ','üëç','üå±'] %}
        <form action="{{ url_for('react', post_id=post['_id'], emoji=emoji) }}" method="post" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-secondary me-1">
            {{ emoji }} {{ post['reactions'].get(emoji, 0) }}
          </button>
        </form>
        {% endfor %}
      </div>
      {% if 'user_id' in session and post['author'] != session['username'] %}
      <div>
        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportModal{{ post['_id'] }}">
          <i class="bi bi-flag"></i> Report
        </button>
      </div>
      {% endif %}
    </div>

    <!-- Report Modal -->
    {% if 'user_id' in session and post['author'] != session['username'] %}
    <div class="modal fade" id="reportModal{{ post['_id'] }}" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="{{ url_for('report_post', post_id=post['_id']) }}" method="post">
            <div class="modal-header">
              <h5 class="modal-title" id="reportModalLabel">Report Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Why are you reporting this post?</p>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="spam{{ post['_id'] }}" value="Spam" checked>
                <label class="form-check-label" for="spam{{ post['_id'] }}">
                  Spam
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="inappropriate{{ post['_id'] }}" value="Inappropriate Content">
                <label class="form-check-label" for="inappropriate{{ post['_id'] }}">
                  Inappropriate Content
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="harassment{{ post['_id'] }}" value="Harassment">
                <label class="form-check-label" for="harassment{{ post['_id'] }}">
                  Harassment or Bullying
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="other{{ post['_id'] }}" value="Other">
                <label class="form-check-label" for="other{{ post['_id'] }}">
                  Other
                </label>
              </div>
              <div class="mt-2">
                <label for="customReason{{ post['_id'] }}" class="form-label">Additional details (optional):</label>
                <textarea class="form-control" id="customReason{{ post['_id'] }}" name="custom_reason" rows="2"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Report</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Comments -->
    <div class="mt-3">
      {% for comment in post['comments'][-3:] %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <strong>{{ comment['username'] }}</strong>: <span class="comment-text">{{ comment['text'] }}</span>
          {% if comment.get('edited') %}<small class="text-muted"> (edited)</small>{% endif %}
        </div>
        {% if 'user_id' in session and (comment['username'] == session['username'] or post['author'] == session['username']) %}
        <div class="btn-group">
          {% if comment['username'] == session['username'] %}
          <a href="{{ url_for('edit_comment', post_id=post['_id'], comment_index=loop.index0) }}" class="btn btn-sm btn-link text-decoration-none">Edit</a>
          {% endif %}
          <form action="{{ url_for('delete_comment', post_id=post['_id'], comment_index=loop.index0) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
            <button type="submit" class="btn btn-sm btn-link text-decoration-none text-danger">Delete</button>
          </form>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if 'user_id' in session %}
      <form action="{{ url_for('comment', post_id=post['_id']) }}" method="post" class="mt-2">
        <div class="input-group">
          <input type="text" name="comment" class="form-control" placeholder="Add a comment..." required>
          <button type="submit" class="btn btn-outline-primary">Post</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}

<!-- Include Edit Post Modal -->
{% include '_edit_post_modal.html' %}

<script>
// Edit Post Modal JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const editPostModal = document.getElementById('editPostModal');
  const editPostForm = document.getElementById('editPostForm');
  const editPostImage = document.getElementById('editPostImage');
  const editImagePreview = document.getElementById('editImagePreview');
  const editPreviewImage = document.getElementById('editPreviewImage');
  const currentImageSection = document.getElementById('currentImageSection');
  const currentImage = document.getElementById('currentImage');
  const removeImageFlag = document.getElementById('removeImageFlag');

  // Handle modal show event
  editPostModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const postId = button.getAttribute('data-post-id');
    const content = button.getAttribute('data-content');
    const imageUrl = button.getAttribute('data-image-url');

    // Populate form fields
    document.getElementById('editPostId').value = postId;
    document.getElementById('editContent').value = content;
    
    // Set form action
    editPostForm.action = `/post/edit/${postId}`;
    console.log('Form action set to:', editPostForm.action);
    
    // Handle current image
    if (imageUrl && imageUrl !== '') {
      currentImage.src = imageUrl;
      currentImageSection.classList.remove('d-none');
      removeImageFlag.value = 'false';
    } else {
      currentImageSection.classList.add('d-none');
      removeImageFlag.value = 'false';
    }
    
    // Reset new image field
    editPostImage.value = '';
    editImagePreview.classList.add('d-none');
  });

  // Handle new image upload
  editPostImage.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        editPreviewImage.src = e.target.result;
        editImagePreview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  });

  // Handle form submission
  editPostForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Debug: Log form data
    console.log('Submitting form to:', this.action);
    for (let [key, value] of formData.entries()) {
      console.log(key, value);
    }
    
    fetch(this.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'fetch'
      },
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Response data:', data);
      if (data.success) {
        // Close the modal
        const modal = bootstrap.Modal.getInstance(editPostModal);
        modal.hide();
        
        // Reload the page to show updated content
        window.location.reload();
      } else {
        throw new Error(data.message || 'Failed to update post');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to update post. Please try again.');
    });
  });

  // Reset modal when hidden
  editPostModal.addEventListener('hidden.bs.modal', function() {
    editPostForm.reset();
    currentImageSection.classList.add('d-none');
    editImagePreview.classList.add('d-none');
    removeImageFlag.value = 'false';
  });
});

// Function to remove current image
function removeCurrentImage() {
  currentImageSection.classList.add('d-none');
  removeImageFlag.value = 'true';
}

// Function to clear new image preview
function clearEditImage() {
  editPostImage.value = '';
  editImagePreview.classList.add('d-none');
  editPreviewImage.src = '#';
}

// Function to confirm and delete post
function confirmDelete(postId) {
  if (confirm('Are you sure you want to delete this post?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/post/delete/${postId}`;
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
