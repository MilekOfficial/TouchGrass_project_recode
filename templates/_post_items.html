{% for post in posts %}
<div class="card mb-3 shadow-sm post-item" id="post-{{ post['_id'] }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <a href="{{ url_for('user_profile', username=post['author']) }}" class="text-decoration-none">
        {{ post['author'] }}
        {% if post.get('author_badges', {}).get('verified') %}
          <span class="badge bg-primary">‚úì</span>
        {% endif %}
      </a>
      <small class="text-muted"> ‚Ä¢ {{ post['created_at']|time_ago if post['created_at'] else '' }}</small>
    </div>
    {% if 'user_id' in session and post['author'] == session['username'] %}
    <div class="btn-group">
      <a href="{{ url_for('edit_post', post_id=post['_id']) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
      <form action="{{ url_for('delete_post', post_id=post['_id']) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
    </div>
    {% endif %}
  </div>
  <div class="card-body">
    <p class="post-content">{{ post['content'] }}</p>
    
    <!-- Hashtags -->
    {% if post.get('hashtags') %}
    <div class="mt-2">
      {% for tag in post['hashtags'] %}
      <a href="{{ url_for('view_hashtag', hashtag=tag) }}" class="badge bg-info text-decoration-none">#{{ tag }}</a>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Reactions -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <div>
        {% for emoji in ['‚ù§Ô∏è','üî•','üòÇ','üëç','üå±'] %}
        <form action="{{ url_for('react', post_id=post['_id'], emoji=emoji) }}" method="post" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-secondary me-1">
            {{ emoji }} {{ post['reactions'].get(emoji, 0) }}
          </button>
        </form>
        {% endfor %}
      </div>
      {% if 'user_id' in session and post['author'] != session['username'] %}
      <div>
        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportModal{{ post['_id'] }}">
          <i class="bi bi-flag"></i> Report
        </button>
      </div>
      {% endif %}
    </div>

    <!-- Report Modal -->
    {% if 'user_id' in session and post['author'] != session['username'] %}
    <div class="modal fade" id="reportModal{{ post['_id'] }}" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="{{ url_for('report_post', post_id=post['_id']) }}" method="post">
            <div class="modal-header">
              <h5 class="modal-title" id="reportModalLabel">Report Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Why are you reporting this post?</p>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="spam{{ post['_id'] }}" value="Spam" checked>
                <label class="form-check-label" for="spam{{ post['_id'] }}">
                  Spam
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="inappropriate{{ post['_id'] }}" value="Inappropriate Content">
                <label class="form-check-label" for="inappropriate{{ post['_id'] }}">
                  Inappropriate Content
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="harassment{{ post['_id'] }}" value="Harassment">
                <label class="form-check-label" for="harassment{{ post['_id'] }}">
                  Harassment or Bullying
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="reason" id="other{{ post['_id'] }}" value="Other">
                <label class="form-check-label" for="other{{ post['_id'] }}">
                  Other
                </label>
              </div>
              <div class="mt-2">
                <label for="customReason{{ post['_id'] }}" class="form-label">Additional details (optional):</label>
                <textarea class="form-control" id="customReason{{ post['_id'] }}" name="custom_reason" rows="2"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Report</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Comments -->
    <div class="mt-3">
      {% for comment in post['comments'][-3:] %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <strong>{{ comment['username'] }}</strong>: <span class="comment-text">{{ comment['text'] }}</span>
          {% if comment.get('edited') %}<small class="text-muted"> (edited)</small>{% endif %}
        </div>
        {% if 'user_id' in session and (comment['username'] == session['username'] or post['author'] == session['username']) %}
        <div class="btn-group">
          {% if comment['username'] == session['username'] %}
          <a href="{{ url_for('edit_comment', post_id=post['_id'], comment_index=loop.index0) }}" class="btn btn-sm btn-link text-decoration-none">Edit</a>
          {% endif %}
          <form action="{{ url_for('delete_comment', post_id=post['_id'], comment_index=loop.index0) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
            <button type="submit" class="btn btn-sm btn-link text-decoration-none text-danger">Delete</button>
          </form>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if 'user_id' in session %}
      <form action="{{ url_for('comment', post_id=post['_id']) }}" method="post" class="mt-2">
        <div class="input-group">
          <input type="text" name="comment" class="form-control" placeholder="Add a comment..." required>
          <button type="submit" class="btn btn-outline-primary">Post</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}
