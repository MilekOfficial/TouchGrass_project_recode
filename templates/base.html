<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if 'user_id' in session and get_user_preferences(session['username']).get('dark_mode', False) else 'light' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TouchGrass</title>
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
      :root {
        --primary-color: #56e482;
        --primary-hover: #3bb03d;
      }
      
      .navbar-brand {
        display: flex;
        align-items: center;
        padding: 5px 0;
      }
      
      .navbar-brand img {
        height: 32px; /* Reduced from 40px */
        width: auto;
        margin-right: 10px;
        max-width: 100%;
      }
      
      .btn-primary, .btn-outline-primary {
        --bs-btn-color: #fff;
        --bs-btn-bg: var(--primary-color);
        --bs-btn-border-color: var(--primary-color);
        --bs-btn-hover-bg: var(--primary-hover);
        --bs-btn-hover-border-color: var(--primary-hover);
        --bs-btn-active-bg: var(--primary-hover);
        --bs-btn-active-border-color: var(--primary-hover);
      }
      
      .text-primary {
        color: var(--primary-color) !important;
      }
      
      .bg-primary {
        background-color: var(--primary-color) !important;
      }
      
      /* Ensure the logo doesn't grow too large on mobile */
      @media (max-width: 576px) {
        .navbar-brand img {
          height: 28px;
        }
        .navbar-brand span {
          font-size: 1.1rem;
        }
      }
      
      /* Topbar strict alignment */
      .navbar .navbar-brand,
      .navbar .nav-link,
      .navbar .btn,
      .navbar .dropdown-toggle,
      .navbar .form-control,
      .navbar .input-group .btn {
        height: 40px;
      }
      .navbar .nav-link { 
        padding-top: 0; 
        padding-bottom: 0; 
        display: inline-flex; 
        align-items: center; 
        gap: .25rem;
      }
      .navbar .navbar-brand { padding: 0; }
      .navbar .navbar-brand img { height: 28px; margin-right: 8px; }
      .navbar .btn, .navbar .dropdown-toggle { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0 .625rem; 
      }
      .navbar .input-group { height: 40px; }
      .navbar .input-group .form-control {
        height: 40px;
        line-height: 1.2;
        box-sizing: border-box;
        padding-top: 0;
        padding-bottom: 0;
      }
      .navbar .input-group .btn { height: 40px; }
      .navbar .input-group { display: flex; align-items: center; }
      .navbar .input-group .form-control { height: 40px; }
    </style>
    <script>
      // Toggle dark mode
      function toggleDarkMode() {
        fetch('{{ url_for("toggle_dark_mode") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(() => {
          const html = document.documentElement;
          const icon = document.getElementById('theme-icon');

          const isDark = html.getAttribute('data-bs-theme') === 'dark';
          html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');

          icon.classList.toggle('bi-moon-stars', !isDark);
          icon.classList.toggle('bi-sun', isDark);
        });
      }
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary align-items-center">
  <div class="container-fluid d-flex align-items-center">
    <!-- Brand -->
    <a class="navbar-brand d-flex align-items-center m-0 p-0" href="{{ url_for('index') }}" style="height: 40px;">
      <img src="{{ url_for('static', filename='Logo.png') }}" alt="TouchGrass Logo" style="height: 32px; width: auto; margin-right: 8px;">
      <span>TouchGrass</span>
    </a>
    
    <!-- Mobile Toggle -->
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <!-- Collapsible Content -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <div class="d-flex w-100 align-items-center justify-content-between">
        <!-- Left Navigation -->
        <ul class="navbar-nav d-flex flex-row gap-1">
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.endpoint == 'index' }} d-flex align-items-center px-3" href="{{ url_for('index') }}" style="height: 40px;">
              <i class="bi bi-house-door me-2"></i> Home
            </a>
          </li>
          {% if 'user_id' in session %}
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.endpoint == 'user_profile' and request.args.get('username') == session['username'] }} d-flex align-items-center px-3" 
               href="{{ url_for('user_profile', username=session['username']) }}" style="height: 40px;">
              <i class="bi bi-person me-2"></i> Profile
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.endpoint == 'notifications' }} d-flex align-items-center px-3 position-relative" 
               href="{{ url_for('notifications') }}" style="height: 40px;">
              <i class="bi bi-bell me-2"></i> Notifications
              {% if notification_count.unread_notifications_count > 0 %}
                <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" style="font-size: 0.6em;">{{ notification_count.unread_notifications_count }}</span>
              {% endif %}
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.endpoint == 'kanban_page' }} d-flex align-items-center px-3" 
               href="{{ url_for('kanban_page') }}" style="height: 40px;">
              <i class="bi bi-kanban me-2"></i> Kanban
            </a>
          </li>
          {% endif %}
        </ul>
        
        <!-- Right Controls -->
        <div class="d-flex align-items-center gap-2">
          <!-- Search -->
          <form class="d-flex align-items-center" action="{{ url_for('search') }}" style="margin-top: 14px;" method="GET">
            <div class="input-group" style="height: 40px;">
              <input class="form-control" type="search" name="q" placeholder="Search..." aria-label="Search" 
                     style="width: 200px; border-right: none;">
              <button class="btn btn-outline-light" type="submit" style="height: 40px; border-left: none; padding: 0 12px;">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>
          
          <!-- Theme Toggle -->
          <button class="btn btn-outline-light d-flex align-items-center justify-content-center" 
                  onclick="toggleDarkMode()" title="Toggle Dark Mode" style="width: 40px; height: 40px; padding: 0;">
            <i id="theme-icon" class="bi {{ 'bi-moon-stars' if 'user_id' in session and get_user_preferences(session['username']).get('dark_mode', False) else 'bi-sun' }}"></i>
          </button>
        
          <!-- User Menu -->
          {% if 'user_id' in session %}
            <div class="dropdown">
              <button class="btn btn-light dropdown-toggle d-flex align-items-center" type="button" 
                      id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="height: 40px; padding: 0 12px;">
                <i class="bi bi-person-circle me-2"></i>
                <span>{{ session['username'] }}</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><h6 class="dropdown-header">Account</h6></li>
                <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('user_profile', username=session['username']) }}">
                  <i class="bi bi-person me-2"></i> My Profile
                </a></li>
                <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('settings') }}">
                  <i class="bi bi-gear me-2"></i> Settings
                </a></li>
                {% if user.badges and user.badges.get('admin') %}
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Admin</h6></li>
                <li><a class="dropdown-item d-flex align-items-center" href="{{ url_for('admin_reports') }}">
                  <i class="bi bi-shield-check me-2"></i> Admin Reports
                </a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger d-flex align-items-center" href="{{ url_for('logout') }}">
                  <i class="bi bi-box-arrow-right me-2"></i> Logout
                </a></li>
              </ul>
            </div>
          {% else %}
            <a href="{{ url_for('login') }}" class="btn btn-light d-flex align-items-center" style="height: 40px; padding: 0 12px;">
              <i class="bi bi-box-arrow-in-right me-2"></i> Login
            </a>
            <a href="{{ url_for('register') }}" class="btn btn-outline-light d-flex align-items-center" style="height: 40px; padding: 0 12px;">
              <i class="bi bi-person-plus me-2"></i> Register
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</nav>
    <div class="container mt-4">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>

    <div class="modal fade" id="postViewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Post</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="postViewModalBody">
            <div class="text-center my-4">
              <div class="spinner-border" role="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-none" id="imageViewer" aria-hidden="true">
      <div class="image-viewer-backdrop" data-action="close-image-viewer"></div>
      <button type="button" class="image-viewer-close" aria-label="Close" data-action="close-image-viewer">Ã—</button>
      <img class="image-viewer-img" id="imageViewerImg" alt="Full size image">
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      
      // Add hashtag links to content
      document.addEventListener('DOMContentLoaded', function() {
        // Convert hashtags to links
        document.querySelectorAll('.post-content, .comment-text').forEach(element => {
          const unicodeHashtag = new RegExp('#([\\p{L}\\p{N}_]+)', 'gu');
          element.innerHTML = element.innerHTML.replace(
            unicodeHashtag,
            '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
          );
        });
      });

      document.addEventListener('click', async (e) => {
        const trigger = e.target.closest('[data-action="view-post"]');
        if (!trigger) return;

        e.preventDefault();

        const postId = trigger.getAttribute('data-post-id');
        if (!postId) return;

        const modalEl = document.getElementById('postViewModal');
        const bodyEl = document.getElementById('postViewModalBody');

        bodyEl.innerHTML = '<div class="text-center my-4"><div class="spinner-border" role="status"></div></div>';

        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();

        try {
          const res = await fetch(`/modal/post/${postId}`, {
            headers: { 'X-Requested-With': 'fetch' },
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          bodyEl.innerHTML = await res.text();

          bodyEl.querySelectorAll('.post-content, .comment-text').forEach(element => {
            const unicodeHashtag = new RegExp('#([\\p{L}\\p{N}_]+)', 'gu');
            element.innerHTML = element.innerHTML.replace(
              unicodeHashtag,
              '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
            );
          });
        } catch (err) {
          bodyEl.innerHTML = '<div class="alert alert-danger">Failed to load post.</div>';
        }
      });

      function openImageViewer(src, altText) {
        const viewer = document.getElementById('imageViewer');
        const img = document.getElementById('imageViewerImg');
        if (!viewer || !img) return;

        img.src = src;
        img.alt = altText || 'Full size image';
        viewer.classList.remove('d-none');
        viewer.setAttribute('aria-hidden', 'false');
        document.body.classList.add('image-viewer-open');
      }

      function closeImageViewer() {
        const viewer = document.getElementById('imageViewer');
        const img = document.getElementById('imageViewerImg');
        if (!viewer || !img) return;

        viewer.classList.add('d-none');
        viewer.setAttribute('aria-hidden', 'true');
        img.src = '';
        document.body.classList.remove('image-viewer-open');
      }

      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-action="close-image-viewer"]');
        if (closeBtn) {
          e.preventDefault();
          closeImageViewer();
          return;
        }

        const img = e.target.closest('img[data-action="view-image"]');
        if (!img) return;
        e.preventDefault();
        openImageViewer(img.currentSrc || img.src, img.alt);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        const viewer = document.getElementById('imageViewer');
        if (!viewer || viewer.classList.contains('d-none')) return;
        closeImageViewer();
      });
    </script>

    <style>
      body.image-viewer-open {
        overflow: hidden;
      }

      #imageViewer {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: grid;
        place-items: center;
      }

      .image-viewer-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .image-viewer-img {
        position: relative;
        z-index: 1;
        max-width: min(95vw, 1200px);
        max-height: 90vh;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
      }

      .image-viewer-close {
        position: absolute;
        top: 18px;
        right: 18px;
        z-index: 2;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 30px;
        line-height: 1;
        cursor: pointer;
      }

      .image-viewer-close:hover {
        background: rgba(0, 0, 0, 0.55);
      }
    </style>

    {% block scripts %}{% endblock %}
  </body>
</html>
