<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ 'dark' if 'user_id' in session and get_user_preferences(session['username']).get('dark_mode', False) else 'light' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TouchGrass</title>
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
      :root {
        --primary-color: #48d14b;
        --primary-hover: #3bb03d;
      }
      
      .navbar-brand {
        display: flex;
        align-items: center;
        padding: 5px 0;
      }
      
      .navbar-brand img {
        height: 32px; /* Reduced from 40px */
        width: auto;
        margin-right: 10px;
        max-width: 100%;
      }
      
      .btn-primary, .btn-outline-primary {
        --bs-btn-color: #fff;
        --bs-btn-bg: var(--primary-color);
        --bs-btn-border-color: var(--primary-color);
        --bs-btn-hover-bg: var(--primary-hover);
        --bs-btn-hover-border-color: var(--primary-hover);
        --bs-btn-active-bg: var(--primary-hover);
        --bs-btn-active-border-color: var(--primary-hover);
      }
      
      .text-primary {
        color: var(--primary-color) !important;
      }
      
      .bg-primary {
        background-color: var(--primary-color) !important;
      }
      
      /* Ensure the logo doesn't grow too large on mobile */
      @media (max-width: 576px) {
        .navbar-brand img {
          height: 28px;
        }
        .navbar-brand span {
          font-size: 1.1rem;
        }
      }
    </style>
    <script src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"></script>
    <script>
      // Toggle dark mode
      function toggleDarkMode() {
        fetch('{{ url_for("toggle_dark_mode") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        }).then(() => {
          document.documentElement.setAttribute(
            'data-bs-theme', 
            document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark'
          );
        });
      }

      // Initialize infinite scroll
      document.addEventListener('DOMContentLoaded', function() {
        const postContainer = document.querySelector('.infinite-scroll');
        if (postContainer) {
          new InfiniteScroll(postContainer, {
            path: '.pagination__next',
            append: '.post-item',
            status: '.scroller-status',
            history: false,
          });
        }
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">
          <img src="{{ url_for('static', filename='Logo.png') }}" alt="TouchGrass Logo" class="img-fluid">
          <span>TouchGrass</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link {{ 'active' if request.endpoint == 'index' }}" href="{{ url_for('index') }}">Home</a>
            </li>
            {% if 'user_id' in session %}
            <li class="nav-item">
              <a class="nav-link {{ 'active' if request.endpoint == 'user_profile' and request.args.get('username') == session['username'] }}" 
                 href="{{ url_for('user_profile', username=session['username']) }}">Profile</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {{ 'active' if request.endpoint == 'notifications' }}" 
                 href="{{ url_for('notifications') }}">
                Notifications
                {% if notification_count.unread_notifications_count > 0 %}
                  <span class="badge bg-danger">{{ notification_count.unread_notifications_count }}</span>
                {% endif %}
              </a>
            </li>
            {% endif %}
          </ul>
          <form class="d-flex me-2" action="{{ url_for('search') }}" method="GET">
            <input class="form-control me-2" type="search" name="q" placeholder="Search..." aria-label="Search">
            <button class="btn btn-outline-light" type="submit">Search</button>
          </form>
          <div class="d-flex align-items-center">
            <button class="btn btn-outline-light me-2" onclick="toggleDarkMode()">
              <i class="bi {{ 'bi-moon-stars' if 'user_id' in session and get_user_preferences(session['username']).get('dark_mode', False) else 'bi-sun' }}"></i>
            </button>
            {% if 'user_id' in session %}
              <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ session['username'] }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                  {% if user.badges and user.badges.get('admin') %}
                  <li><a class="dropdown-item" href="{{ url_for('admin_reports') }}">Admin Reports</a></li>
                  <li><hr class="dropdown-divider"></li>
                  {% endif %}
                  <li><a class="dropdown-item" href="{{ url_for('settings') }}">Settings</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
              </div>
            {% else %}
              <a href="{{ url_for('login') }}" class="btn btn-light me-2">Login</a>
              <a href="{{ url_for('register') }}" class="btn btn-outline-light">Register</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container mt-4">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      <div class="infinite-scroll">
        {% block content %}{% endblock %}
        
        <!-- Infinite scroll pagination -->
        {% if has_next_page %}
        <div class="d-none">
          <a class="pagination__next" href="{{ next_page_url }}"></a>
        </div>
        <div class="scroller-status">
          <div class="infinite-scroll-request text-center my-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <p class="infinite-scroll-last text-muted text-center my-4">No more posts to load</p>
          <p class="infinite-scroll-error text-muted text-center my-4">No more posts to load</p>
        </div>
        {% endif %}
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Update theme icon based on current theme
      function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
          icon.textContent = '☀️';
        } else {
          icon.textContent = '🌙';
        }
      }
      
      // Initial theme icon update
      updateThemeIcon();
      
      // Add hashtag links to content
      document.addEventListener('DOMContentLoaded', function() {
        // Convert hashtags to links
        document.querySelectorAll('.post-content, .comment-text').forEach(element => {
          element.innerHTML = element.innerHTML.replace(
            /#(\w+)/g, 
            '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
          );
        });
      });
    </script>
  </body>
</html>
