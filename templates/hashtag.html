{% extends 'base.html' %}

{% block content %}
<!-- Create New Post Section -->
{% if 'user_id' in session %}
<div class="card mb-4 shadow-sm border-0 bg-gradient">
  <div class="card-body text-center py-4">
    <button type="button" class="btn btn-primary btn-lg px-5 py-3 shadow-lg" data-bs-toggle="modal" data-bs-target="#newPostModal" onclick="prefillHashtag('#{{ hashtag }}')" style="background: linear-gradient(135deg, #56e482 0%, #3bb03d 100%); border: none; border-radius: 50px; font-weight: 600; transition: all 0.3s ease;">
      <i class="bi bi-plus-circle-fill me-2"></i>
      Create Post with #{{ hashtag }}
    </button>
    <p class="text-muted mt-3 mb-0 small">Share your thoughts about #{{ hashtag }}</p>
  </div>
</div>

<style>
  .bg-gradient {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(86, 228, 130, 0.3) !important;
  }
  
  .btn:active {
    transform: translateY(0);
  }
</style>
{% endif %}

<div class="mb-4">
  <h2>#{{ hashtag }}</h2>
  <p class="text-muted">Posts tagged with #{{ hashtag }}</p>
</div>

<div class="infinite-scroll">
  {% for post in posts %}
  <div class="card mb-3 shadow-sm post-item">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <a href="{{ url_for('user_profile', username=post['author']) }}" class="text-decoration-none">
          {{ post['author'] }}
          {% if users_col.find_one({'username': post['author']}).get('badges', {}).get('verified') %}
            <span class="badge bg-primary">‚úì</span>
          {% endif %}
        </a>
        <small class="text-muted"> ‚Ä¢ {{ post['created_at']|time_ago if post['created_at'] else '' }}</small>
      </div>
      {% if 'user_id' in session and post['author'] == session['username'] %}
      <div class="btn-group">
        <a href="{{ url_for('edit_post', post_id=post['_id']) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
        <form action="{{ url_for('delete_post', post_id=post['_id']) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
          <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
        </form>
      </div>
      {% endif %}
    </div>
    <div class="card-body">
      <p class="post-content">{{ post['content'] }}</p>
      
      <!-- Post Image -->
      {% if post.get('image_url') %}
      <div class="mt-2 mb-3">
        <img src="{{ post.image_url }}" alt="Post image" class="img-fluid rounded" style="max-height: 400px; width: auto; max-width: 100%;">
      </div>
      {% endif %}
      
      <!-- Hashtags -->
      {% if post.get('hashtags') %}
      <div class="mt-2">
        {% for tag in post['hashtags'] %}
        <a href="{{ url_for('view_hashtag', hashtag=tag) }}" class="badge bg-info text-decoration-none">#{{ tag }}</a>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- Reactions -->
      <div class="mt-3">
        {% for emoji in ['‚ù§Ô∏è','üî•','üòÇ','üëç','üå±'] %}
        <form action="{{ url_for('react', post_id=post['_id'], emoji=emoji) }}" method="post" class="d-inline">
          <button type="submit" class="btn btn-sm btn-outline-secondary me-1">
            {{ emoji }} {{ post['reactions'].get(emoji, 0) }}
          </button>
        </form>
        {% endfor %}
      </div>
      
      <!-- Comments -->
      <div class="mt-3">
        {% for comment in post['comments'][-3:] %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <strong>{{ comment['username'] }}</strong>: <span class="comment-text">{{ comment['text'] }}</span>
            {% if comment.get('edited') %}<small class="text-muted"> (edited)</small>{% endif %}
          </div>
          {% if 'user_id' in session and (comment['username'] == session['username'] or post['author'] == session['username']) %}
          <div class="btn-group">
            {% if comment['username'] == session['username'] %}
            <a href="{{ url_for('edit_comment', post_id=post['_id'], comment_index=loop.index0) }}" class="btn btn-sm btn-link text-decoration-none">Edit</a>
            {% endif %}
            <form action="{{ url_for('delete_comment', post_id=post['_id'], comment_index=loop.index0) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
              <button type="submit" class="btn btn-sm btn-link text-decoration-none text-danger">Delete</button>
            </form>
          </div>
          {% endif %}
        </div>
        {% endfor %}
        
        {% if 'user_id' in session %}
        <form action="{{ url_for('comment', post_id=post['_id']) }}" method="post" class="mt-2">
          <div class="input-group">
            <input type="text" name="comment" class="form-control" placeholder="Add a comment..." required>
            <button type="submit" class="btn btn-outline-primary">Post</button>
          </div>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  
  {% if has_more %}
  <div class="d-none">
    <a class="pagination__next" href="{{ url_for('view_hashtag', hashtag=hashtag, page=page+1) }}"></a>
  </div>
  {% endif %}
</div>
{% endblock %}

<!-- Include New Post Modal (only for logged-in users) -->
{% if 'user_id' in session %}
  {% include '_new_post_modal.html' %}
  
  <script>
  // New Post Modal JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const newPostModal = document.getElementById('newPostModal');
    const newPostForm = document.getElementById('newPostForm');
    const newPostImage = document.getElementById('newPostImage');
    const newPostImagePreview = document.getElementById('newPostImagePreview');
    const newPostPreviewImage = document.getElementById('newPostPreviewImage');

    if (newPostModal) {
      // Handle new image upload
      newPostImage.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            newPostPreviewImage.src = e.target.result;
            newPostImagePreview.classList.remove('d-none');
          };
          reader.readAsDataURL(file);
        }
      });

      // Handle form submission
      newPostForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'fetch'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(newPostModal);
            modal.hide();
            
            // Reload the page to show the new post
            window.location.reload();
          } else {
            throw new Error(data.message || 'Failed to create post');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to create post. Please try again.');
        });
      });

      // Reset modal when hidden
      newPostModal.addEventListener('hidden.bs.modal', function() {
        newPostForm.reset();
        newPostImagePreview.classList.add('d-none');
      });
    }
  });

  // Helper function to insert emoji in new post modal
  function insertNewPostEmoji(emoji) {
    const textarea = document.getElementById('newPostContent');
    if (textarea) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const before = text.substring(0, start);
      const after = text.substring(end, text.length);
      textarea.value = before + emoji + after;
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
    }
  }

  // Function to clear new post image preview
  function clearNewPostImage() {
    const newPostImage = document.getElementById('newPostImage');
    const newPostImagePreview = document.getElementById('newPostImagePreview');
    const newPostPreviewImage = document.getElementById('newPostPreviewImage');
    
    if (newPostImage && newPostImagePreview && newPostPreviewImage) {
      newPostImage.value = '';
      newPostImagePreview.classList.add('d-none');
      newPostPreviewImage.src = '#';
    }
  }

  // Function to prefill hashtag in modal
  function prefillHashtag(hashtag) {
    const textarea = document.getElementById('newPostContent');
    if (textarea) {
      textarea.value = hashtag + ' ';
      textarea.focus();
      // Move cursor to end
      textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }
  }
  </script>
{% endif %}
