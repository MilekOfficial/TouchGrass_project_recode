{% extends 'base.html' %}

{% block content %}
  {% if 'user_id' in session %}
  <div class="card mb-4 shadow-sm border-0 bg-gradient">
    <div class="card-body text-center py-4">
      <button type="button" class="btn btn-primary btn-lg px-5 py-3 shadow-lg" data-bs-toggle="modal" data-bs-target="#newPostModal" style="background: linear-gradient(135deg, #56e482 0%, #3bb03d 100%); border: none; border-radius: 50px; font-weight: 600; transition: all 0.3s ease;">
        <i class="bi bi-plus-circle-fill me-2"></i>
        Create New Post
      </button>
      <p class="text-muted mt-3 mb-0 small">Share your thoughts with the community</p>
    </div>
  </div>
  
  <style>
    .bg-gradient {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(86, 228, 130, 0.3) !important;
    }
    
    .btn:active {
      transform: translateY(0);
    }
  </style>
  {% endif %}

  <div id="posts-container" class="infinite-scroll">
    {% include '_post_items.html' %}
    
    {% if has_more %}
    <div class="d-none">
      <a class="pagination__next" href="{{ url_for('index', page=next_page) }}"></a>
    </div>
    {% endif %}
  </div>
  
  <div class="scroller-status">
    <div class="infinite-scroll-request text-center my-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <p class="infinite-scroll-last text-muted text-center my-4">No more posts to load</p>
    <p class="infinite-scroll-error text-muted text-center my-4">No more posts to load</p>
  </div>
{% endblock %}

{% block scripts %}
<script>
// Initialize infinite scroll
const postsContainer = document.querySelector('.infinite-scroll');
if (postsContainer) {
  new InfiniteScroll(postsContainer, {
    path: '.pagination__next',
    append: '.post-item',
    status: '.scroller-status',
    history: false,
    prefill: true,
    responseType: 'document',
    loadOnScroll: true,
    button: '.view-more-button',
    scrollThreshold: 100,
    debug: false
  });
}

// Helper function to insert emoji at cursor position
function insertEmoji(emoji) {
  const textarea = document.querySelector('textarea[name="content"]');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  const before = text.substring(0, start);
  const after = text.substring(end, text.length);
  textarea.value = before + emoji + after;
  textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
  textarea.focus();
}

// Convert hashtags to links in new content
document.addEventListener('DOMContentLoaded', function() {
  // Initial conversion for static content
  document.querySelectorAll('.post-content, .comment-text').forEach(element => {
    const unicodeHashtag = new RegExp('#([\\p{L}\\p{N}_]+)', 'gu');
    element.innerHTML = element.innerHTML.replace(
      unicodeHashtag,
      '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
    );
  });
  
  // Handle dynamically loaded content
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) { // Element node
          node.querySelectorAll('.post-content, .comment-text').forEach(element => {
            const unicodeHashtag = new RegExp('#([\\p{L}\\p{N}_]+)', 'gu');
            element.innerHTML = element.innerHTML.replace(
              unicodeHashtag,
              '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
            );
          });
        }
      });
    });
  });
  
  // Start observing the document with the configured parameters
  observer.observe(document.body, { childList: true, subtree: true });
});

// Add event listener to image input field
document.getElementById('post_image').addEventListener('change', function() {
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewContainer = document.getElementById('imagePreview');
  const file = this.files[0];
  const reader = new FileReader();
  
  reader.onload = function(event) {
    imagePreview.src = event.target.result;
    imagePreviewContainer.classList.remove('d-none');
  };
  
  reader.readAsDataURL(file);
});

// Function to clear image preview
function clearImage() {
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewContainer = document.getElementById('imagePreview');
  imagePreview.src = '#';
  imagePreviewContainer.classList.add('d-none');
}

// New Post Modal JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const newPostModal = document.getElementById('newPostModal');
  const newPostForm = document.getElementById('newPostForm');
  const newPostImage = document.getElementById('newPostImage');
  const newPostImagePreview = document.getElementById('newPostImagePreview');
  const newPostPreviewImage = document.getElementById('newPostPreviewImage');

  // Handle new image upload
  newPostImage.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        newPostPreviewImage.src = e.target.result;
        newPostImagePreview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  });

  // Handle form submission
  newPostForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Debug: Log form data
    console.log('Submitting new post form to:', this.action);
    for (let [key, value] of formData.entries()) {
      console.log(key, value);
    }
    
    fetch(this.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'fetch'
      },
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('Response data:', data);
      if (data.success) {
        // Close the modal
        const modal = bootstrap.Modal.getInstance(newPostModal);
        modal.hide();
        
        // Reload the page to show the new post
        window.location.reload();
      } else {
        throw new Error(data.message || 'Failed to create post');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to create post. Please try again.');
    });
  });

  // Reset modal when hidden
  newPostModal.addEventListener('hidden.bs.modal', function() {
    newPostForm.reset();
    newPostImagePreview.classList.add('d-none');
  });
});

// Helper function to insert emoji in new post modal
function insertNewPostEmoji(emoji) {
  const textarea = document.getElementById('newPostContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  const before = text.substring(0, start);
  const after = text.substring(end, text.length);
  textarea.value = before + emoji + after;
  textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
  textarea.focus();
}

// Function to clear new post image preview
function clearNewPostImage() {
  const newPostImage = document.getElementById('newPostImage');
  const newPostImagePreview = document.getElementById('newPostImagePreview');
  const newPostPreviewImage = document.getElementById('newPostPreviewImage');
  
  newPostImage.value = '';
  newPostImagePreview.classList.add('d-none');
  newPostPreviewImage.src = '#';
}
</script>
{% endblock %}

<!-- Include New Post Modal -->
{% include '_new_post_modal.html' %}
