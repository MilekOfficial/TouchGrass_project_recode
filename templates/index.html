{% extends 'base.html' %}

{% block content %}
  {% if 'user_id' in session %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form action="{{ url_for('post') }}" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <textarea class="form-control" name="content" rows="3" placeholder="What's on your mind?" required></textarea>
          <small class="form-text text-muted">Use #hashtags to categorize your post</small>
        </div>
        
        <!-- Image Upload Field -->
        <div class="mb-3">
          <label for="post_image" class="form-label">Add an image (optional):</label>
          <input class="form-control" type="file" id="post_image" name="post_image" accept="image/*">
          <div class="form-text">Max size: 10MB. Supported formats: JPG, PNG, GIF</div>
          <div id="imagePreview" class="mt-2 d-none">
            <img id="previewImage" src="#" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="clearImage()">Remove Image</button>
          </div>
        </div>
        
        <div class="mt-2 d-flex justify-content-between align-items-center">
          <div class="emoji-picker">
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="insertEmoji('üòä')">üòä</button>
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="insertEmoji('üëç')">üëç</button>
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="insertEmoji('üòÇ')">üòÇ</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertEmoji('üå±')">üå±</button>
          </div>
          <button type="submit" class="btn btn-primary">Post</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div id="posts-container" class="infinite-scroll">
    {% include '_post_items.html' %}
    
    {% if has_more %}
    <div class="d-none">
      <a class="pagination__next" href="{{ url_for('index', page=next_page) }}"></a>
    </div>
    {% endif %}
  </div>
  
  <div class="scroller-status">
    <div class="infinite-scroll-request text-center my-4">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <p class="infinite-scroll-last text-muted text-center my-4">No more posts to load</p>
    <p class="infinite-scroll-error text-muted text-center my-4">No more posts to load</p>
  </div>
{% endblock %}

{% block scripts %}
<script>
// Initialize infinite scroll
const postsContainer = document.querySelector('.infinite-scroll');
if (postsContainer) {
  new InfiniteScroll(postsContainer, {
    path: '.pagination__next',
    append: '.post-item',
    status: '.scroller-status',
    history: false,
    prefill: true,
    responseType: 'document',
    loadOnScroll: true,
    button: '.view-more-button',
    scrollThreshold: 100,
    debug: false
  });
}

// Helper function to insert emoji at cursor position
function insertEmoji(emoji) {
  const textarea = document.querySelector('textarea[name="content"]');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  const before = text.substring(0, start);
  const after = text.substring(end, text.length);
  textarea.value = before + emoji + after;
  textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
  textarea.focus();
}

// Convert hashtags to links in new content
document.addEventListener('DOMContentLoaded', function() {
  // Initial conversion for static content
  document.querySelectorAll('.post-content, .comment-text').forEach(element => {
    element.innerHTML = element.innerHTML.replace(
      /#(\w+)/g, 
      '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
    );
  });
  
  // Handle dynamically loaded content
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) { // Element node
          node.querySelectorAll('.post-content, .comment-text').forEach(element => {
            element.innerHTML = element.innerHTML.replace(
              /#(\w+)/g, 
              '<a href="/hashtag/$1" class="text-decoration-none">#$1</a>'
            );
          });
        }
      });
    });
  });
  
  // Start observing the document with the configured parameters
  observer.observe(document.body, { childList: true, subtree: true });
});

// Add event listener to image input field
document.getElementById('post_image').addEventListener('change', function() {
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewContainer = document.getElementById('imagePreview');
  const file = this.files[0];
  const reader = new FileReader();
  
  reader.onload = function(event) {
    imagePreview.src = event.target.result;
    imagePreviewContainer.classList.remove('d-none');
  };
  
  reader.readAsDataURL(file);
});

// Function to clear image preview
function clearImage() {
  const imagePreview = document.getElementById('imagePreview');
  const imagePreviewContainer = document.getElementById('imagePreview');
  imagePreview.src = '#';
  imagePreviewContainer.classList.add('d-none');
}
</script>
{% endblock %}
