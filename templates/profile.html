{% extends 'base.html' %}
{% block content %}
  <!-- Cover Photo with Update Button -->
  <div class="card mb-4 shadow-sm">
    <div class="card-img-top position-relative" style="height: 200px; background-color: #4CAF50; display: flex; align-items: center; justify-content: center;">
      {% if user.get('cover_photo') %}
        <img src="{{ user.cover_photo }}?v={{ user.get('profile_version', 0) }}" 
             alt="Cover photo" 
             class="w-100 h-100" 
             style="object-fit: cover;">
      {% else %}
        <div style="color: white; font-size: 24px; font-weight: bold;">TouchGrass</div>
      {% endif %}
    </div>
    <div class="card-body position-relative">
      <!-- Profile Picture -->
      <div class="d-flex align-items-start">
        <div class="position-relative" style="margin-top: -75px; margin-bottom: 15px;">
          {% set avatar_src = user.get('profile_pic') or user.get('avatar_url') or url_for('static', filename='default_profile.png') %}
          <img src="{{ avatar_src }}?v={{ user.get('profile_version', 0) }}" 
               class="rounded-circle border border-4 border-white" 
               width="150" 
               height="150"
               style="object-fit: cover;"
               alt="{{ user['username'] }}">
        </div>
        
        <!-- User Info -->
        <div class="ms-4 flex-grow-1">
          <div class="d-flex align-items-center mb-2">
            <h3 class="mb-0 me-2">{{ user['username'] }}</h3>
            {% if user.get('badges', {}) %}
              <div class="d-flex">
                {% for badge, has_badge in user['badges'].items() %}
                  {% if has_badge %}
                    <span class="badge {% if badge == 'admin' %}bg-danger{% else %}bg-primary{% endif %} me-1" 
                          data-bs-toggle="tooltip" 
                          title="{{ badge.replace('_', ' ').title() }}">
                      {{ badge|title }}
                    </span>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            {% if user.get('location') %}
              <p class="text-muted mb-2">
                <i class="bi bi-geo-alt-fill"></i> {{ user['location'] }}
                {% if 'user_id' in session %}
                  {% if session['username'] == user['username'] %}
                    <button type="button" class="btn btn-sm btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#editLocationModal">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                  {% endif %}
                {% endif %}
              </p>
            {% elif 'user_id' in session %}
              {% if session['username'] == user['username'] %}
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editLocationModal">
                  <i class="bi bi-plus"></i> Add Location
                </button>
              {% endif %}
            {% endif %}
            
            {% if user.get('bio') %}
              <p class="mb-3">{{ user['bio'] }}</p>
            {% endif %}
          </div>
          
          <div class="d-flex align-items-center mb-3">
            <a href="#" class="text-decoration-none text-dark me-4">
              <strong>{{ posts|length }}</strong> Posts
            </a>
            <a href="#" class="text-decoration-none text-dark me-4">
              <strong>{{ followers_count }}</strong> Followers
            </a>
            <a href="#" class="text-decoration-none text-dark">
              <strong>{{ following_count }}</strong> Following
            </a>
          </div>
          <!-- AddToAny BEGIN -->
<div style="margin-bottom: 10px;">
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_email"></a>
<a class="a2a_button_whatsapp"></a>
<a class="a2a_button_snapchat"></a>
<a class="a2a_button_x"></a>
<a class="a2a_button_microsoft_teams"></a>
<a class="a2a_button_threads"></a>
<a class="a2a_button_reddit"></a>
<a class="a2a_button_pinterest"></a>
<a class="a2a_button_telegram"></a>
<a class="a2a_button_facebook_messenger"></a>
</div>
<script defer src="https://static.addtoany.com/menu/page.js"></script>
</div>
<hr>
<!-- AddToAny END -->
          {% if 'user_id' in session %}
            {% if session['username'] == user['username'] %}
              <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm">
                Edit Profile
              </a>
            {% else %}
              {% if is_following %}
                <form action="{{ url_for('unfollow_user', username=user['username']) }}" method="post" class="d-inline">
                  <button class="btn btn-outline-secondary btn-sm">Unfollow</button>
                </form>
              {% else %}
                <form action="{{ url_for('follow_user', username=user['username']) }}" method="post" class="d-inline">
                  <button class="btn btn-green btn-sm">Follow</button>
                </form>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Location Modal -->
  {% if 'user_id' in session %}
    {% if session['username'] == user['username'] %}
      <div class="modal fade" id="editLocationModal" tabindex="-1" aria-labelledby="editLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editLocationModalLabel">Update Location</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('update_profile') }}" method="post">
              <div class="modal-body">
                <div class="mb-3">
                  <label for="location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="location" name="location" value="{{ user.get('location', '') }}" placeholder="Enter your location">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>



      <!-- Update Profile Picture Modal -->
     
    {% endif %}
  {% endif %}

  <!-- Create New Post Section (only for own profile) -->
  {% if 'user_id' in session and session['username'] == user['username'] %}
  <div class="card mb-4 shadow-sm border-0 bg-gradient">
    <div class="card-body text-center py-4">
      <button type="button" class="btn btn-primary btn-lg px-5 py-3 shadow-lg" data-bs-toggle="modal" data-bs-target="#newPostModal" style="background: linear-gradient(135deg, #56e482 0%, #3bb03d 100%); border: none; border-radius: 50px; font-weight: 600; transition: all 0.3s ease;">
        <i class="bi bi-plus-circle-fill me-2"></i>
        Create New Post
      </button>
      <p class="text-muted mt-3 mb-0 small">Share your thoughts with your followers</p>
    </div>
  </div>
  
  <style>
    .bg-gradient {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(86, 228, 130, 0.3) !important;
    }
    
    .btn:active {
      transform: translateY(0);
    }
  </style>
  {% endif %}

  <!-- User Posts -->
  <div class="row">
    {% if posts %}
      {% for post in posts %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <p class="card-text">{{ post['content'] }}</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-muted">{{ post['created_at']|time_ago if post['created_at'] else '' }}</small>
              {% if post.get('hashtags') %}
                <div class="mt-2">
                  {% for tag in post['hashtags'] %}
                    <a href="{{ url_for('view_hashtag', hashtag=tag) }}" class="text-decoration-none">
                      <span class="badge bg-light text-dark">#{{ tag }}</span>
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="col-12 text-center py-5">
        <div class="display-4 text-muted mb-3">ðŸŒ±</div>
        <h4>No posts yet</h4>
        <p class="text-muted">When {{ user['username'] }} shares something, you'll see it here.</p>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Initialize tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
{% endblock %}

<!-- Include New Post Modal (only for logged-in users) -->
{% if 'user_id' in session %}
  {% include '_new_post_modal.html' %}
  
  <script>
  // New Post Modal JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const newPostModal = document.getElementById('newPostModal');
    const newPostForm = document.getElementById('newPostForm');
    const newPostImage = document.getElementById('newPostImage');
    const newPostImagePreview = document.getElementById('newPostImagePreview');
    const newPostPreviewImage = document.getElementById('newPostPreviewImage');

    if (newPostModal) {
      // Handle new image upload
      newPostImage.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            newPostPreviewImage.src = e.target.result;
            newPostImagePreview.classList.remove('d-none');
          };
          reader.readAsDataURL(file);
        }
      });

      // Handle form submission
      newPostForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'fetch'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(newPostModal);
            modal.hide();
            
            // Reload the page to show the new post
            window.location.reload();
          } else {
            throw new Error(data.message || 'Failed to create post');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to create post. Please try again.');
        });
      });

      // Reset modal when hidden
      newPostModal.addEventListener('hidden.bs.modal', function() {
        newPostForm.reset();
        newPostImagePreview.classList.add('d-none');
      });
    }
  });

  // Helper function to insert emoji in new post modal
  function insertNewPostEmoji(emoji) {
    const textarea = document.getElementById('newPostContent');
    if (textarea) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const before = text.substring(0, start);
      const after = text.substring(end, text.length);
      textarea.value = before + emoji + after;
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
    }
  }

  // Function to clear new post image preview
  function clearNewPostImage() {
    const newPostImage = document.getElementById('newPostImage');
    const newPostImagePreview = document.getElementById('newPostImagePreview');
    const newPostPreviewImage = document.getElementById('newPostPreviewImage');
    
    if (newPostImage && newPostImagePreview && newPostPreviewImage) {
      newPostImage.value = '';
      newPostImagePreview.classList.add('d-none');
      newPostPreviewImage.src = '#';
    }
  }
  </script>
{% endif %}
